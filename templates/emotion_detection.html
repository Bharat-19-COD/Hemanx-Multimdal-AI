{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-100 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">Emotion Analysis</h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                Discover your emotional state through multiple analysis methods. 
                Choose your preferred way to analyze emotions.
            </p>
        </div>

        <!-- Analysis Methods Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            <!-- Face Analysis Card -->
            <div class="bg-white rounded-2xl shadow-xl p-8 hover-lift border border-blue-100">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-camera text-blue-600 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Face Analysis</h3>
                    <p class="text-gray-600">Real-time emotion detection using your camera</p>
                </div>
                
                <div class="space-y-4">
                    <div id="webcam-container" class="hidden">
                        <div class="relative bg-gray-900 rounded-lg overflow-hidden">
                            <video id="webcam" autoplay playsinline class="w-full h-48 object-cover"></video>
                            <canvas id="canvas" class="absolute top-0 left-0 w-full h-48"></canvas>
                            <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
                                <div id="emotion-indicator" class="bg-black bg-opacity-50 text-white px-4 py-2 rounded-full text-sm hidden">
                                    <span id="current-emotion">Analyzing...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="webcam-controls" class="text-center">
                        <button id="start-camera" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300 flex items-center justify-center">
                            <i class="fas fa-video mr-3"></i>
                            Start Live Detection
                        </button>
                        <button id="stop-camera" class="w-full bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold transition duration-300 hidden mt-2">
                            <i class="fas fa-stop mr-3"></i>
                            Stop Camera
                        </button>
                    </div>
                </div>
            </div>

            <!-- Text Analysis Card -->
            <div class="bg-white rounded-2xl shadow-xl p-8 hover-lift border border-green-100">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-keyboard text-green-600 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Text Questionnaire</h3>
                    <p class="text-gray-600">Answer questions to analyze your emotions</p>
                </div>
                
                <div class="space-y-4">
                    <div id="questionnaire" class="space-y-4">
                        <div class="question">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                1. How are you feeling right now?
                            </label>
                            <textarea 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                rows="2"
                                placeholder="Describe your current emotions..."
                            ></textarea>
                        </div>
                        
                        <div class="question">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                2. What's been on your mind lately?
                            </label>
                            <textarea 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                rows="2"
                                placeholder="Share your thoughts..."
                            ></textarea>
                        </div>
                        
                        <div class="question">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                3. How would you describe your energy level today?
                            </label>
                            <select class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                <option value="">Select your energy level</option>
                                <option value="very_low">Very Low</option>
                                <option value="low">Low</option>
                                <option value="moderate">Moderate</option>
                                <option value="high">High</option>
                                <option value="very_high">Very High</option>
                            </select>
                        </div>
                        
                        <div class="question">
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                4. What emotions have you felt most strongly this week?
                            </label>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="ml-2 text-sm text-gray-700">Joy/Happiness</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="ml-2 text-sm text-gray-700">Sadness</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="ml-2 text-sm text-gray-700">Anger</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="ml-2 text-sm text-gray-700">Fear/Anxiety</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="ml-2 text-sm text-gray-700">Surprise</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="rounded border-gray-300 text-green-600 focus:ring-green-500">
                                    <span class="ml-2 text-sm text-gray-700">Neutral/Calm</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button id="analyze-text" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300">
                        <i class="fas fa-search mr-3"></i>
                        Analyze Questionnaire
                    </button>
                    
                    <div id="text-result" class="hidden p-4 bg-green-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-green-800">Dominant Emotion:</span>
                            <span id="text-emotion" class="bg-green-200 text-green-800 px-3 py-1 rounded-full text-sm"></span>
                        </div>
                        <div class="mt-2 text-sm text-green-700" id="text-confidence"></div>
                        <div class="mt-2 text-sm text-green-700" id="text-sentiment"></div>
                    </div>
                </div>
            </div>

            <!-- Voice Analysis Card -->
            <div class="bg-white rounded-2xl shadow-xl p-8 hover-lift border border-purple-100">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-microphone text-purple-600 text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Voice Analysis</h3>
                    <p class="text-gray-600">Record your voice to detect emotional tone</p>
                </div>
                
                <div class="space-y-4">
                    <!-- Recording Interface -->
                    <div id="recording-interface" class="text-center">
                        <div class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">Click record and speak for 5-10 seconds about how you're feeling</p>
                        </div>
                        
                        <div id="recording-controls" class="space-y-3">
                            <button id="start-recording" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300">
                                <i class="fas fa-microphone mr-3"></i>
                                Start Recording
                            </button>
                            
                            <div id="recording-status" class="hidden">
                                <div class="flex items-center justify-center space-x-2">
                                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                                    <span class="text-sm text-red-600 font-medium">Recording...</span>
                                </div>
                                <div class="mt-2">
                                    <span id="recording-timer" class="text-sm text-gray-600">00:05</span>
                                </div>
                            </div>
                            
                            <button id="stop-recording" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300 hidden">
                                <i class="fas fa-stop mr-3"></i>
                                Stop Recording
                            </button>
                            
                            <audio id="audio-preview" class="w-full hidden" controls></audio>
                        </div>
                    </div>
                    
                    <button id="analyze-voice" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300 disabled:opacity-50" disabled>
                        <i class="fas fa-play mr-3"></i>
                        Analyze Voice
                    </button>
                    
                    <div id="voice-result" class="hidden p-4 bg-purple-50 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="font-semibold text-purple-800">Emotion:</span>
                            <span id="voice-emotion" class="bg-purple-200 text-purple-800 px-3 py-1 rounded-full text-sm"></span>
                        </div>
                        <div class="mt-2 text-sm text-purple-700" id="voice-confidence"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Analysis Results -->
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">Recent Analysis</h2>
            <div id="recent-results" class="space-y-4">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-chart-line text-3xl mb-3"></i>
                    <p>Your recent emotion analysis results will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Emotion Results Modal -->
<div id="results-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-2xl p-8 max-w-md w-full mx-4">
        <div class="text-center">
            <div id="result-emoji" class="text-6xl mb-4">üòä</div>
            <h3 id="result-title" class="text-2xl font-bold text-gray-900 mb-2">Analysis Complete</h3>
            <p id="result-message" class="text-gray-600 mb-6">Your emotion has been analyzed successfully</p>
            
            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-700">Wellness Score:</span>
                    <span id="result-score" class="font-bold text-blue-600">0/10</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div id="result-progress" class="bg-blue-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            
            <button id="close-modal" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-6 rounded-lg font-semibold transition duration-300">
                Continue Analysis
            </button>
        </div>
    </div>
</div>

<style>
.hover-lift {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.hover-lift:hover {
    transform: translateY(-8px);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

#webcam-container video {
    transform: scaleX(-1); /* Mirror effect */
}

.emotion-pill {
    transition: all 0.3s ease;
}

.emotion-pill:hover {
    transform: scale(1.05);
}

/* Pulse animation for real-time analysis */
.pulse-ring {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.7; }
    100% { transform: scale(1); opacity: 1; }
}

/* Recording animation */
.recording-pulse {
    animation: recording-pulse 1.5s infinite;
}

@keyframes recording-pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}
</style>

<script>
class EmotionAnalyzer {
    constructor() {
        this.mediaStream = null;
        this.isAnalyzing = false;
        this.analysisInterval = null;
        this.audioRecorder = null;
        this.audioChunks = [];
        this.recordingTimer = null;
        this.recordingTime = 0;
        this.maxRecordingTime = 10; // seconds
        
        this.initializeEventListeners();
        this.loadRecentResults();
    }

    initializeEventListeners() {
        // Camera controls
        document.getElementById('start-camera').addEventListener('click', () => this.startCamera());
        document.getElementById('stop-camera').addEventListener('click', () => this.stopCamera());
        
        // Text analysis
        document.getElementById('analyze-text').addEventListener('click', () => this.analyzeTextQuestionnaire());
        
        // Voice recording controls
        document.getElementById('start-recording').addEventListener('click', () => this.startRecording());
        document.getElementById('stop-recording').addEventListener('click', () => this.stopRecording());
        document.getElementById('analyze-voice').addEventListener('click', () => this.analyzeVoiceRecording());
        
        // Modal controls
        document.getElementById('close-modal').addEventListener('click', () => this.closeResultsModal());
        document.getElementById('results-modal').addEventListener('click', (e) => {
            if (e.target.id === 'results-modal') this.closeResultsModal();
        });
    }

    async startCamera() {
        try {
            this.mediaStream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480 } 
            });
            
            const video = document.getElementById('webcam');
            video.srcObject = this.mediaStream;
            
            document.getElementById('webcam-container').classList.remove('hidden');
            document.getElementById('start-camera').classList.add('hidden');
            document.getElementById('stop-camera').classList.remove('hidden');
            
            this.startFaceAnalysis();
            
        } catch (error) {
            this.showNotification('Camera access denied or not available', 'error');
            console.error('Camera error:', error);
        }
    }

    stopCamera() {
        if (this.mediaStream) {
            this.mediaStream.getTracks().forEach(track => track.stop());
            this.mediaStream = null;
        }
        
        this.isAnalyzing = false;
        if (this.analysisInterval) {
            clearInterval(this.analysisInterval);
        }
        
        document.getElementById('webcam-container').classList.add('hidden');
        document.getElementById('start-camera').classList.remove('hidden');
        document.getElementById('stop-camera').classList.add('hidden');
        document.getElementById('emotion-indicator').classList.add('hidden');
    }

    startFaceAnalysis() {
        this.isAnalyzing = true;
        this.analysisInterval = setInterval(() => {
            this.captureAndAnalyzeFrame();
        }, 3000); // Analyze every 3 seconds
    }

    async captureAndAnalyzeFrame() {
        const video = document.getElementById('webcam');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        if (video.videoWidth === 0 || video.videoHeight === 0) {
            return; // Video not ready
        }
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const imageData = canvas.toDataURL('image/jpeg');
        
        try {
            const response = await fetch('/emotion/analyze/face', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ image: imageData })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                this.updateEmotionIndicator(result.dominant_emotion, result.wellness_score);
                this.showResultsModal(result.dominant_emotion, result.wellness_score, 'face');
                this.loadRecentResults();
            } else {
                console.error('Face analysis failed:', result.error);
            }
        } catch (error) {
            console.error('Face analysis error:', error);
            this.showNotification('Face analysis failed. Please try again.', 'error');
        }
    }

    updateEmotionIndicator(emotion, score) {
        const indicator = document.getElementById('emotion-indicator');
        const emotionText = document.getElementById('current-emotion');
        
        emotionText.textContent = `${emotion.charAt(0).toUpperCase() + emotion.slice(1)} ‚Ä¢ ${score}/10`;
        indicator.classList.remove('hidden');
        
        // Add pulse animation
        indicator.classList.add('pulse-ring');
    }

    async analyzeTextQuestionnaire() {
    // Collect all questionnaire data
    const questions = document.querySelectorAll('#questionnaire .question');
    const questionnaireData = {
        feeling: questions[0]?.querySelector('textarea')?.value || '',
        thoughts: questions[1]?.querySelector('textarea')?.value || '',
        energy: questions[2]?.querySelector('select')?.value || '',
        emotions: Array.from(questions[3]?.querySelectorAll('input:checked') || [])
            .map(cb => {
                const label = cb.nextElementSibling;
                return label ? label.textContent.trim() : '';
            })
            .filter(emotion => emotion)
    };

    console.log("Questionnaire data:", questionnaireData);

    // Combine all text for analysis
    const combinedText = [
        questionnaireData.feeling ? `I am feeling: ${questionnaireData.feeling}` : '',
        questionnaireData.thoughts ? `My thoughts: ${questionnaireData.thoughts}` : '',
        questionnaireData.energy ? `Energy level: ${questionnaireData.energy}` : '',
        questionnaireData.emotions.length > 0 ? `Strong emotions: ${questionnaireData.emotions.join(', ')}` : ''
    ].filter(text => text).join('. ');

    console.log("Combined text:", combinedText);

    if (!combinedText.trim()) {
        this.showNotification('Please answer at least the first question', 'error');
        return;
    }

    const analyzeBtn = document.getElementById('analyze-text');
    analyzeBtn.disabled = true;
    analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Analyzing...';

    try {
        const response = await fetch('/emotion/analyze/text', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ 
                text: combinedText, 
                questionnaire: questionnaireData 
            })
        });
        
        console.log("Response status:", response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error("Server response:", errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log("Analysis result:", result);
        
        if (result.success) {
            this.displayTextResult(result);
            this.showResultsModal(result.analysis.dominant_emotion, result.wellness_score, 'text');
            this.loadRecentResults();
        } else {
            this.showNotification(result.error || 'Questionnaire analysis failed', 'error');
        }
    } catch (error) {
        console.error('Text analysis error:', error);
        this.showNotification('Analysis failed: ' + error.message, 'error');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = '<i class="fas fa-search mr-3"></i>Analyze Questionnaire';
    }
}

    displayTextResult(result) {
        const resultDiv = document.getElementById('text-result');
        const emotion = document.getElementById('text-emotion');
        const confidence = document.getElementById('text-confidence');
        const sentiment = document.getElementById('text-sentiment');
        
        emotion.textContent = result.analysis.dominant_emotion.charAt(0).toUpperCase() + result.analysis.dominant_emotion.slice(1);
        confidence.textContent = `Confidence: ${(result.analysis.confidence * 100).toFixed(1)}%`;
        sentiment.textContent = `Sentiment: ${result.analysis.sentiment.charAt(0).toUpperCase() + result.analysis.sentiment.slice(1)}`;
        resultDiv.classList.remove('hidden');
    }

    async startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            this.audioRecorder = new MediaRecorder(stream);
            this.audioChunks = [];

            this.audioRecorder.ondataavailable = (event) => {
                this.audioChunks.push(event.data);
            };

            this.audioRecorder.onstop = () => {
                const audioBlob = new Blob(this.audioChunks, { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                // Show audio preview
                const audioPreview = document.getElementById('audio-preview');
                audioPreview.src = audioUrl;
                audioPreview.classList.remove('hidden');
                
                // Enable analyze button
                document.getElementById('analyze-voice').disabled = false;
                
                // Store blob for analysis
                this.recordedAudioBlob = audioBlob;
                
                // Stop all tracks
                stream.getTracks().forEach(track => track.stop());
            };

            this.audioRecorder.start();
            this.startRecordingTimer();

            // Update UI
            document.getElementById('start-recording').classList.add('hidden');
            document.getElementById('stop-recording').classList.remove('hidden');
            document.getElementById('recording-status').classList.remove('hidden');

        } catch (error) {
            this.showNotification('Microphone access denied or not available', 'error');
            console.error('Recording error:', error);
        }
    }

    stopRecording() {
        if (this.audioRecorder && this.audioRecorder.state === 'recording') {
            this.audioRecorder.stop();
            this.stopRecordingTimer();
            
            // Update UI
            document.getElementById('start-recording').classList.remove('hidden');
            document.getElementById('stop-recording').classList.add('hidden');
            document.getElementById('recording-status').classList.add('hidden');
        }
    }

    startRecordingTimer() {
        this.recordingTime = 0;
        this.recordingTimer = setInterval(() => {
            this.recordingTime++;
            const remaining = this.maxRecordingTime - this.recordingTime;
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining % 60;
            
            document.getElementById('recording-timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (this.recordingTime >= this.maxRecordingTime) {
                this.stopRecording();
            }
        }, 1000);
    }

    stopRecordingTimer() {
        if (this.recordingTimer) {
            clearInterval(this.recordingTimer);
            this.recordingTimer = null;
        }
    }

    async analyzeVoiceRecording() {
        if (!this.recordedAudioBlob) {
            this.showNotification('Please record audio first', 'error');
            return;
        }

        const analyzeBtn = document.getElementById('analyze-voice');
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Analyzing...';

        try {
            const formData = new FormData();
            formData.append('audio', this.recordedAudioBlob, 'recording.wav');

            const response = await fetch('/emotion/analyze/voice', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                this.displayVoiceResult(result);
                this.showResultsModal(result.dominant_emotion, result.wellness_score, 'voice');
                this.loadRecentResults();
            } else {
                this.showNotification(result.error || 'Voice analysis failed', 'error');
            }
        } catch (error) {
            console.error('Voice analysis error:', error);
            this.showNotification('Network error occurred. Please try again.', 'error');
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = '<i class="fas fa-play mr-3"></i>Analyze Voice';
        }
    }

    displayVoiceResult(result) {
        const resultDiv = document.getElementById('voice-result');
        const emotion = document.getElementById('voice-emotion');
        const confidence = document.getElementById('voice-confidence');
        
        emotion.textContent = result.dominant_emotion.charAt(0).toUpperCase() + result.dominant_emotion.slice(1);
        confidence.textContent = `Confidence: ${(result.confidence * 100).toFixed(1)}%`;
        resultDiv.classList.remove('hidden');
    }

    showResultsModal(emotion, score, type) {
        const modal = document.getElementById('results-modal');
        const emoji = document.getElementById('result-emoji');
        const title = document.getElementById('result-title');
        const message = document.getElementById('result-message');
        const resultScore = document.getElementById('result-score');
        const progress = document.getElementById('result-progress');
        
        // Set emoji based on emotion
        const emojiMap = {
            'joy': 'üòä', 'happy': 'üòä', 'sadness': 'üò¢', 'sad': 'üò¢', 
            'anger': 'üò†', 'angry': 'üò†', 'fear': 'üò®', 'surprise': 'üò≤', 
            'neutral': 'üòê', 'positive': 'üëç', 'negative': 'üëé',
            'disgust': 'ü§¢'
        };
        
        emoji.textContent = emojiMap[emotion.toLowerCase()] || 'üòä';
        title.textContent = `${emotion.charAt(0).toUpperCase() + emotion.slice(1)} Detected`;
        message.textContent = `Your ${type} analysis shows ${emotion} emotion`;
        resultScore.textContent = `${score}/10`;
        progress.style.width = `${score * 10}%`;
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    closeResultsModal() {
        document.getElementById('results-modal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    async loadRecentResults() {
        try {
            const response = await fetch('/emotion/recent?limit=5', {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) {
                return;
            }
            
            const result = await response.json();
            
            if (result.success) {
                this.displayRecentResults(result.emotions || []);
            }
        } catch (error) {
            console.error('Failed to load recent results:', error);
        }
    }

    displayRecentResults(emotions) {
        const container = document.getElementById('recent-results');
        
        if (!emotions || emotions.length === 0) {
            container.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-chart-line text-3xl mb-3"></i>
                    <p>Your recent emotion analysis results will appear here</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = emotions.map(emotion => `
            <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition duration-300">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-${this.getAnalysisIcon(emotion.analysis_type)} text-blue-600"></i>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-900 capitalize">${emotion.dominant_emotion || 'Unknown'}</h4>
                        <p class="text-sm text-gray-600">${this.formatTimestamp(emotion.timestamp)} ‚Ä¢ ${emotion.analysis_type || 'analysis'}</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                        ${emotion.wellness_score || 5}/10
                    </span>
                </div>
            </div>
        `).join('');
    }

    getAnalysisIcon(type) {
        const icons = {
            'face': 'camera',
            'text': 'keyboard', 
            'voice': 'microphone',
            'comprehensive': 'chart-line'
        };
        return icons[type] || 'chart-line';
    }

    formatTimestamp(timestamp) {
        try {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
        } catch (e) {
            return 'Just now';
        }
    }

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'error' ? 'bg-red-500 text-white' : 
            type === 'success' ? 'bg-green-500 text-white' : 
            'bg-blue-500 text-white'
        }`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 3000);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new EmotionAnalyzer();
});
</script>
{% endblock %}